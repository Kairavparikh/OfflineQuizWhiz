"""
Test real VLM (LLaVA) with your somatosensory PDF.

This will:
1. Extract diagram from your PDF
2. Use LLaVA to generate a REAL diagram-based question
3. Show you the difference from mock questions
"""

from pathlib import Path
from pdf_extractor import extract_pdf, create_text_image_pairs
from multimodal_generator import MultimodalMCQGenerator
from vlm_client import VLMConfig, VLMClient
from models import DifficultyLevel

print("\n" + "="*80)
print("TESTING REAL VLM (LLaVA) WITH YOUR PDF")
print("="*80)

pdf_path = "/Users/kairavparikh/Downloads/somatosensory.pdf"

if not Path(pdf_path).exists():
    print(f"\n‚ùå PDF not found: {pdf_path}")
    exit(1)

# Step 1: Extract PDF
print(f"\nüìÑ Extracting diagrams from: {Path(pdf_path).name}")
pdf_doc = extract_pdf(pdf_path, pages=[1, 2, 3])

print(f"   ‚úÖ Found {pdf_doc.total_images} diagram(s)")

# Step 2: Create pairs
pairs = create_text_image_pairs(pdf_doc)

if not pairs:
    print("\n‚ùå No diagrams found in PDF")
    exit(1)

print(f"   ‚úÖ Created {len(pairs)} text-image pair(s)")

# Step 3: Set up REAL VLM (LLaVA)
print(f"\n‚ö° Setting up LLaVA...")
vlm_config = VLMConfig(
    base_url="http://localhost:11434",
    model_name="llava",
    timeout_seconds=180
)
vlm_client = VLMClient(vlm_config)

# Test connection
if not vlm_client.test_connection():
    print("‚ùå LLaVA not available. Make sure: ollama serve")
    exit(1)

print(f"   ‚úÖ LLaVA connected and ready")

# Step 4: Generate REAL diagram-based question
print(f"\nü§ñ Generating diagram-based question with LLaVA...")
print(f"   (This may take 60-120 seconds)")

generator = MultimodalMCQGenerator(vlm_client=vlm_client)

try:
    questions = generator.generate_from_pair(
        pair=pairs[0],
        subject="Sensory Systems",
        main_topic="Somatosensory System",
        subtopic="Muscle Spindles",
        difficulty=DifficultyLevel.MEDIUM,
        n=1  # Generate 1 question
    )

    if questions:
        q = questions[0]

        print("\n" + "="*80)
        print("‚úÖ REAL DIAGRAM-BASED QUESTION GENERATED!")
        print("="*80)

        print(f"\nüìä Source Diagram: Page {pairs[0].page_number}")
        print(f"   Caption: {pairs[0].images[0].caption[:80]}...")

        print(f"\n‚ùì Question:")
        print(f"   {q.question_text_en}")

        print(f"\n   Options:")
        for label, text in q.get_options_dict().items():
            marker = "‚úÖ" if label == q.correct_answer else "  "
            print(f"   {marker} {label}) {text}")

        print(f"\n   ‚úì Correct: {q.correct_answer}")

        print(f"\nüí° Explanation:")
        print(f"   {q.explanation}")

        print(f"\nüìö References:")
        for ref in q.references:
            print(f"   ‚Ä¢ {ref}")

        print("\n" + "="*80)
        print("‚úÖ REAL VLM TEST SUCCESSFUL!")
        print("="*80)

        print("\nThis question was generated by LLaVA LOOKING AT the diagram!")
        print("It understands the visual content and creates relevant questions.")

    else:
        print("\n‚ùå No questions generated")

except Exception as e:
    print(f"\n‚ùå Error: {e}")
    import traceback
    traceback.print_exc()

print("\n" + "="*80)
